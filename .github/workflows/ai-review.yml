# =============================================================================
# JobFit AI â€” AI Code Review Bot
# =============================================================================
# Automatically reviews PR diffs using OpenAI GPT-4o-mini.
# Posts review comments directly on the PR.
# Works alongside CodeRabbit (if installed) as a complementary layer.

name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  ai-review:
    name: "AI Code Review"
    runs-on: ubuntu-latest
    # Skip bot PRs and draft PRs
    if: github.event.pull_request.draft == false && github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD -- \
            '*.py' '*.tsx' '*.ts' '*.yml' '*.yaml' \
            ':!package-lock.json' ':!*.lock' \
            > pr_diff.txt
          DIFF_SIZE=$(wc -c < pr_diff.txt | tr -d ' ')
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT
          echo "Diff size: $DIFF_SIZE bytes"

      - name: AI Review
        if: steps.diff.outputs.diff_size > 100
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const fs = require('fs');

            // Read diff (truncate to ~12K chars to stay within token limits)
            const fullDiff = fs.readFileSync('pr_diff.txt', 'utf8');
            const diff = fullDiff.slice(0, 12000);
            const truncated = fullDiff.length > 12000;

            const systemPrompt = `You are a senior code reviewer for JobFit AI â€” a multi-tenant SaaS resume optimization platform.

            Tech stack: Python 3.11 + FastAPI (backend), Next.js 14 + TypeScript (frontend).
            Architecture: Domain-Driven Design with 5 bounded contexts (identity, resume, optimization, interview, billing).

            Review rules (CHECK STRICTLY):

            1. DDD LAYER VIOLATIONS:
               - Domain layer files (*/domain/*.py) must NOT import FastAPI, SQLAlchemy, or any framework.
               - API layer must use DTOs, never expose domain entities directly.
               - Infrastructure implements domain interfaces only.

            2. MULTI-TENANT ISOLATION:
               - Every repository query MUST include tenant_id filtering.
               - Flag any SELECT/INSERT/UPDATE without WHERE tenant_id as ðŸ”´ CRITICAL.

            3. SECURITY:
               - No hardcoded secrets, API keys, or passwords.
               - No 'any' type in TypeScript.
               - No bare 'except:' in Python.
               - JWT tokens must not be stored in localStorage.

            4. TESTING:
               - PRs adding features must include corresponding tests.
               - Test naming: test_<method>_<scenario>_<expected>.

            5. CODE QUALITY:
               - No magic numbers â€” use named constants.
               - All public classes and functions must have docstrings (Python) or JSDoc (TypeScript).
               - Conventional Commits format for PR title.

            Output format:
            - Use bullet points grouped by severity.
            - ðŸ”´ Critical: Must fix before merge (security, data leakage, layer violations).
            - ðŸŸ¡ Warning: Should fix (missing tests, poor naming, anti-patterns).
            - ðŸŸ¢ Suggestion: Nice to have (style, performance, readability).
            - If the code looks good, say so briefly.
            - Be concise. Max 20 bullet points.`;

            const userPrompt = `Review this PR diff:\n\n\`\`\`diff\n${diff}\n\`\`\`${truncated ? '\n\n(Note: diff was truncated. Only partial review is possible.)' : ''}`;

            try {
              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'gpt-4o-mini',
                  messages: [
                    { role: 'system', content: systemPrompt },
                    { role: 'user', content: userPrompt }
                  ],
                  temperature: 0.2,
                  max_tokens: 2000
                })
              });

              if (!response.ok) {
                console.log(`OpenAI API error: ${response.status}`);
                return;
              }

              const result = await response.json();
              const review = result.choices[0].message.content;
              const tokensUsed = result.usage?.total_tokens || 'unknown';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ðŸ¤– AI Code Review\n\n${review}\n\n---\n<sub>Powered by GPT-4o-mini | Tokens used: ${tokensUsed} | [Review rules](docs/04-technical-standards.md)</sub>`
              });

              console.log(`Review posted. Tokens used: ${tokensUsed}`);
            } catch (error) {
              console.log(`AI review failed: ${error.message}`);
              // Don't fail the workflow if AI review fails
            }

      - name: Skip notice
        if: steps.diff.outputs.diff_size <= 100
        run: echo "Diff too small (${{ steps.diff.outputs.diff_size }} bytes), skipping AI review."
