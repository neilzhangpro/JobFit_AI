---
description: Docker Compose, environment management, and CI/CD rules
globs: "{docker-compose*.yml,Dockerfile,**/Dockerfile,.env*,Makefile,.github/**/*.yml}"
alwaysApply: false
---

# Docker, Environment, and CI/CD Rules

## Multi-File Compose Strategy

- `docker-compose.yml`: Base services only — NO environment-specific settings
- `docker-compose.dev.yml`: Dev overrides (ports, volume mounts, hot reload, debug)
- `docker-compose.prod.yml`: Prod overrides (resource limits, health checks, restart policies)
- NEVER use `docker-compose.override.yml` (auto-loading is implicit and error-prone)

## Use Makefile Commands

Always prefer `make` commands over raw `docker compose`:

```bash
make dev            # Start dev environment
make dev-build      # Start with fresh build
make down           # Stop all services
make test           # Run all tests
make lint           # Run all linters + type checks
make migrate        # Apply DB migrations
make clean          # Full reset (delete volumes + images)
```

## Dockerfile Rules

- Multi-stage builds required: `base` → `dev` / `prod` stages
- Production stage: non-root user (`USER appuser`), slim image, no dev tools
- NEVER pass secrets via `ARG` or `ENV` in Dockerfile — inject at runtime
- Pin base image versions exactly (e.g., `python:3.11.9-slim`, not `python:3.11-slim`)

## Secrets

- NEVER commit `.env` files — only `.env.example` with placeholders
- NEVER put real secrets in Docker build args or Dockerfiles
- Production `.env` on server: `chmod 600`, owned by deploy user only
- `gitleaks` runs in CI pipeline on every PR to catch accidental leaks

## CI/CD Pipeline (GitHub Actions)

- **On PR** (`ci.yml`): 6 parallel checks must all pass before merge:
  lint → test → coverage (>= 80%) → secret scan → docker build
- **On merge to main** (`cd.yml`): build prod images → push to GHCR → deploy to EC2
- **AI Review** (`ai-review.yml`): GPT-4o-mini reviews every PR diff automatically
- Deploy includes health check; auto-rollback on failure

## Environment Differences

| Concern | Development | Production |
|---------|-------------|------------|
| Source mounting | Volume bind mounts | Code baked in image |
| Hot reload | Yes (--reload) | No |
| DB port exposed | Yes (host access) | No (internal only) |
| Log level | DEBUG | WARNING |
| Workers | 1 | 4+ |
| Restart policy | no | unless-stopped |
